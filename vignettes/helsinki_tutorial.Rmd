---
title: "Helsinki open data R tools"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Helsinki open data R tools}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, 
  warning = FALSE,
  fig.height = 7, 
  fig.width = 7,
  dpi = 75
)
```


helsinki - tutorial
===========

This R package provides tools to access open data from the Helsinki region in Finland
as part of the [rOpenGov](http://ropengov.org) project.

For contact information and source code, see the [github page](https://github.com/rOpenGov/helsinki). 

## Available data sources

[Helsinki region district maps](#aluejakokartat) (Helsingin seudun aluejakokartat)

* Aluejakokartat: kunta, pien-, suur-, tilastoalueet (Helsinki region district maps)
* Äänestysaluejako: (Helsinki region election district maps)
* Source: [Helsingin kaupungin Kiinteistövirasto (HKK)](http://ptp.hel.fi/avoindata/)

Helsinki Real Estate Department (HKK:n avointa dataa)

* Spatial data from [Helsingin kaupungin Kiinteistövirasto (HKK)](http://ptp.hel.fi/avoindata/) availabe in the [gisfin](https://github.com/rOpenGov/gisfin) package, see [gisfin tutorial](https://github.com/rOpenGov/gisfin/blob/master/vignettes/gisfin_tutorial.md) for examples

[Helsinki region environmental services](#hsy) (HSY:n avointa dataa)

* Väestötietoruudukko (population grid)
* Rakennustietoruudukko (building information grid)
* SeutuRAMAVA (building land resource information(?))
* Source: Helsingin seudun ympäristöpalvelut, HSY

[Service and event information](#servicemap)

* [Helsinki region Service Map API](http://api.hel.fi/servicemap/v2/) (Pääkaupunkiseudun Palvelukartta)
* [Helsinki Linked Event API](http://api.hel.fi/linkedevents/v1/)

[Helsinki Region Infoshare statistics API](#hri_stats)

* [Aluesarjat (original source)](http://www.aluesarjat.fi/) (regional time series data)
* Source: [Helsinki Region Infoshare statistics API](http://dev.hel.fi/stats/)


List of potential data sources to be added to the package can be found [here](todo-datasets.Rmd).

## Installation

Release version for general users:

```{r install_default, eval=FALSE}
install.packages("helsinki")
```

Development version for developers:

```{r install_remotes, eval=FALSE}
library(remotes)
remotes::install_github("ropengov/helsinki")
```

Load package.

```{r load, message=FALSE, warning=FALSE, results='hide'}
library(helsinki)
```

## <a name="aluejakokartat"></a>Helsinki region district maps

Helsinki region geographic data can be accessed from a WFS API by using the get_city_map() function. Data is available for all 4 cities in the capital region: Helsinki, Espoo, Vantaa and Kauniainen. 

Administrative divisions can be accessed on 3 distinct levels: "suuralue", "tilastoalue" and "pienalue". Literal, completely unofficial translations for these could be "grand district", "statistical area" and "(minor) district". The naming convention of these levels is sometimes confusing even in Finnish documents and different names can vary by city and time. 

The main takeaway is that "suuralue" is the highest-level division and "pienalue" is the most granular level of division. "Tilastoalue" is between these two.

In addition, it is possible to download "aanestysalue" (voting district) divisions for the city of Helsinki. Currently this data is not available for other cities.

```{r city_map_visuals, eval=FALSE}
library(sf)
map <- get_city_map(city = "helsinki", level = "suuralue")
plot(sf::st_geometry(map))

voting_district <- get_city_map(city = "helsinki", level = "aanestysalue")
plot(sf::st_geometry(voting_district))
```

For other cities than Helsinki voting areas (and other district maps) can be viewed from the legacy dataset with `data(aluejakokartat)`. The data included with the packaged is available as both spatial object (`sp`) and data frame (`df`). This data was preprocessed with the now-defunct gisfin-package (actively maintained version is called [geofi](https://github.com/rOpenGov/geofi)) and its inclusion in the package may change in the next releases.

```{r aluejako_data, message=FALSE}
# Load aluejakokartat and study contents
data(aluejakokartat)
str(aluejakokartat, m=2)
```


## <a name="servicemap"></a>Service and event information

Function `get_servicemap()` retrieves regional service data from the new [Service Map API](http://api.hel.fi/servicemap/v2/), that contains data from the [Service Map](http://dev.hel.fi/servicemap/).

```{r servicemap, message=FALSE, warning=FALSE}
# Search for "puisto" (park) (specify q="query")
search_puisto <- get_servicemap(query="search", q="puisto")
# Study results: 47 variables in the data frame
str(search_puisto, max.level = 1)
```

We can see that this search returns a large number of results, over 2000. The results are returned as pages, where each page has 20 results by default. By giving no additional search parameters, we get 20 results from the first page of search results.

```{r}
# Get names for the first 20 results
search_puisto$results$name$fi

# See what kind of data is given for services
names(search_puisto$results)
```

More results could be retrieved and viewed by giving additional search parameters.

```{r}
search_puisto <- get_servicemap(query="search", q="puisto", page_size = 30, page = 2)
search_puisto$results$name$fi
```

As we could see from above example, the returned data frame had 47 observations. At full width this output can be messy to handle. One option would be to turn it into a tibble, the other to limit the extent of the query at the start. This can be done with only parameter:

```{r}
# Search for padel-related services in Helsinki
search_padel <- get_servicemap(query="search", input="padel", only="unit.name, unit.location.coordinates, unit.street_address", municipality="helsinki")
search_padel$results
```

Function `get_linkedevents()` retrieves regional event data from the new [Linked Events API](http://api.hel.fi/linkedevents/v0.1/).

```{r linkedevents, message=FALSE, warning=FALSE}
# Search for current events
events <- get_linkedevents(query="event")
# Get names for the first 20 results
events$data$name$fi
# See what kind of data is given for events
names(events$data)
```



## <a name="hri_stats"></a> Helsinki Region Infoshare statistics API

Function `get_hri_stats()` retrieves data from the [Helsinki Region Infoshare statistics API](http://dev.hel.fi/stats/).

```{r hri_stats1, message=FALSE, warning=FALSE}
# Retrieve list of available data
stats.list <- get_hri_stats(query="")
# Show first results
head(stats.list)
```

Specify a dataset to retrieve. The output is currently a three-dimensional array.

```{r hri_stats2, message=FALSE, warning=FALSE}
# Retrieve a specific dataset
stats.res <- get_hri_stats(query=stats.list[1])
# Show the structure of the results
str(stats.res)
```

The implementation will be updated and more examples will be added in the near future.


### Citation

**Citing the data:** See `help()` to get citation information for each data source individually.

**Citing the R package:**

```{r citation, comment=NA}
citation("helsinki")
```

### Session info


This vignette was created with

```{r sessioninfo, message=FALSE, warning=FALSE}
sessionInfo()
```

